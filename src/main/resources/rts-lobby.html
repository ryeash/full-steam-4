<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Full Steam RTS - Matchmaking</title>
    <meta name="description" content="Full Steam RTS - Real-time strategy multiplayer game">
    <link rel="stylesheet" type="text/css" href="unified.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #lobby-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 20px;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #00ff88, #00cc66);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        #stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-label {
            color: #aaa;
            font-size: 0.9em;
            margin-top: 3px;
        }

        .matchmaking-section {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #00ff88;
            border-radius: 12px;
            padding: 25px 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        .matchmaking-section h2 {
            color: #00ff88;
            margin-bottom: 15px;
        }

        .matchmaking-section p {
            color: #ccc;
            margin-bottom: 20px;
            font-size: 1em;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .primary-button {
            padding: 15px 35px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #00ff88, #00cc66);
            color: #000;
        }

        .primary-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.5);
        }

        .primary-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .secondary-button {
            padding: 12px 28px;
            font-size: 1em;
            font-weight: bold;
            border: 2px solid #ff9500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #ff9500, #ff6600);
            color: #fff;
        }

        .secondary-button:hover {
            background: linear-gradient(45deg, #ff6600, #ff4400);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.4);
        }

        .debug-button {
            padding: 10px 22px;
            font-size: 0.95em;
            border: 2px solid #666;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }

        .debug-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #888;
        }

        .config-group {
            text-align: left;
        }

        .config-label {
            display: block;
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .config-select {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ff88;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .config-select:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00cc66;
        }

        .config-select:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .config-description {
            margin-top: 8px;
            color: #aaa;
            font-size: 0.9em;
            font-style: italic;
        }

        #matchmaking-status {
            display: none;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00ff88;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        #matchmaking-status.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 20px auto;
            border: 6px solid rgba(0, 255, 136, 0.2);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .waiting-message {
            font-size: 1.3em;
            color: #00ff88;
            margin-bottom: 10px;
        }

        .waiting-details {
            color: #aaa;
            margin-bottom: 20px;
        }

        .player-list {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .player-slot {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px 25px;
            min-width: 150px;
        }

        .player-slot.filled {
            border-color: #00ff88;
        }

        .player-slot.empty {
            border-style: dashed;
        }

        .player-name {
            font-weight: bold;
            color: #00ff88;
        }

        .player-status {
            font-size: 0.9em;
            color: #888;
            margin-top: 5px;
        }

        .active-games-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
        }

        .active-games-section h2 {
            color: #00ff88;
            margin-bottom: 15px;
        }

        #games-list {
            list-style: none;
            padding: 0;
        }

        .game-item {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .game-item:hover {
            border-color: #00ff88;
            transform: translateX(5px);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .game-type {
            font-size: 1.1em;
            font-weight: bold;
            color: #00ff88;
        }

        .game-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .game-status.waiting {
            background: rgba(255, 149, 0, 0.3);
            border: 1px solid #ff9500;
            color: #ff9500;
        }

        .game-status.ready {
            background: rgba(0, 255, 136, 0.3);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .game-info {
            display: flex;
            gap: 25px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .info-item {
            color: #ccc;
        }

        .info-label {
            color: #888;
            font-size: 0.9em;
        }

        .info-value {
            color: #fff;
            font-weight: bold;
        }

        .join-button {
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #00ff88, #00cc66);
            color: #000;
        }

        .join-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.4);
        }

        .join-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .cancel-button {
            padding: 12px 30px;
            font-size: 1em;
            border: 2px solid #ff4444;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .cancel-button:hover {
            background: rgba(255, 68, 68, 0.4);
            transform: translateY(-2px);
        }

        .faction-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 900px;
            margin: 15px auto;
        }

        .faction-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .faction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }

        .faction-card.selected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .faction-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .faction-description {
            color: #aaa;
            font-size: 0.85em;
            line-height: 1.3;
        }

        .faction-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
<div id="lobby-wrapper">
    <h1>‚öîÔ∏è Full Steam RTS ‚öîÔ∏è</h1>
    <div class="subtitle">Real-Time Strategy Multiplayer</div>

    <div id="stats-bar">
        <div class="stat-item">
            <span class="stat-value" id="player-count-value">0</span>
            <div class="stat-label">Players Online</div>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="games-count-value">0</span>
            <div class="stat-label">Active Games</div>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="server-status">üü¢</span>
            <div class="stat-label">Server Status</div>
        </div>
    </div>

    <!-- Faction Selection Section -->
    <div class="matchmaking-section" id="faction-section">
        <h2>üèõÔ∏è Choose Your Faction</h2>
        <p>Select a faction to determine your available units, buildings, and strategic bonuses</p>
        <div class="faction-selector">
            <div class="faction-card selected" data-faction="TERRAN" onclick="selectFaction('TERRAN')">
                <div class="faction-icon">üõ°Ô∏è</div>
                <div class="faction-name" style="color: #4169E1;">Terran Coalition</div>
                <div class="faction-description">
                    Balanced military force with access to all standard units and buildings.
                    Versatile and adaptable to any situation. +10% building health.
                </div>
            </div>
            <div class="faction-card" data-faction="NOMADS" onclick="selectFaction('NOMADS')">
                <div class="faction-icon">üèéÔ∏è</div>
                <div class="faction-name" style="color: #FF8C00;">Nomad Clans</div>
                <div class="faction-description">
                    Fast and mobile warfare specialists. Vehicles are 20% cheaper and faster,
                    but buildings are 20% weaker. +50% upkeep limit.
                </div>
            </div>
            <div class="faction-card" data-faction="SYNTHESIS" onclick="selectFaction('SYNTHESIS')">
                <div class="faction-icon">‚ö°</div>
                <div class="faction-name" style="color: #00CED1;">Synthesis Collective</div>
                <div class="faction-description">
                    Advanced technology faction with powerful units and 30% better power efficiency.
                    Units are 30% more expensive but buildings are 15% stronger.
                </div>
            </div>
        </div>
    </div>

    <!-- Create Game Section -->
    <div class="matchmaking-section" id="create-game-section">
        <h2>üéÆ Create a Match</h2>
        <p>Configure your game settings and create a match for others to join</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; max-width: 1000px; margin: 20px auto 30px;">
            <div class="config-group">
                <label for="biome-select" class="config-label">Biome</label>
                <select id="biome-select" class="config-select">
                    <option value="GRASSLAND">üå≥ Grassland</option>
                    <option value="DESERT">üèúÔ∏è Desert</option>
                    <option value="SNOW">‚ùÑÔ∏è Snow</option>
                    <option value="VOLCANIC">üåã Volcanic</option>
                    <option value="URBAN">üèôÔ∏è Urban</option>
                </select>
                <div class="config-description" id="biome-description">A lush grassland with scattered trees</div>
            </div>

            <div class="config-group">
                <label for="density-select" class="config-label">Obstacle Density</label>
                <select id="density-select" class="config-select">
                    <option value="SPARSE">Sparse (50%)</option>
                    <option value="MEDIUM" selected>Medium (100%)</option>
                    <option value="DENSE">Dense (150%)</option>
                    <option value="VERY_DENSE">Very Dense (200%)</option>
                </select>
                <div class="config-description">Map obstacle count</div>
            </div>

            <div class="config-group">
                <label for="player-count-select" class="config-label">Number of Players</label>
                <select id="player-count-select" class="config-select">
                    <option value="2" selected>2 Players</option>
                    <option value="3">3 Players</option>
                    <option value="4">4 Players</option>
                </select>
                <div class="config-description">Free-for-all match</div>
            </div>
        </div>

        <div class="button-group">
            <button class="primary-button" id="create-game-button" onclick="createMatch()">
                ‚ûï Create Match
            </button>
            <button class="debug-button" onclick="createDebugGame()">
                ü§ñ Play vs AI (Debug)
            </button>
        </div>
    </div>

    <!-- Matchmaking Status (hidden by default) -->
    <div id="matchmaking-status">
        <div class="spinner"></div>
        <div class="waiting-message" id="waiting-message">Waiting for players to join...</div>
        <div class="waiting-details" id="queue-time">Time in lobby: 0s</div>
        <div class="player-list" id="player-list">
            <div class="player-slot filled">
                <div class="player-name">You</div>
                <div class="player-status">Ready</div>
            </div>
            <div class="player-slot empty">
                <div class="player-name">Waiting...</div>
                <div class="player-status">Empty</div>
            </div>
        </div>
        <button class="cancel-button" onclick="cancelMatchmaking()">Leave Lobby</button>
    </div>

    <!-- Active Games -->
    <div class="active-games-section">
        <h2>üéØ Join Existing Games</h2>
        <ul id="games-list">
            <li class="empty-state">Loading games...</li>
        </ul>
    </div>
</div>

<script type="text/javascript">
    const gamesList = document.getElementById('games-list');
    const playerCountValue = document.getElementById('player-count-value');
    const gamesCountValue = document.getElementById('games-count-value');
    const serverStatus = document.getElementById('server-status');
    const createGameSection = document.getElementById('create-game-section');
    const matchmakingStatus = document.getElementById('matchmaking-status');
    const createGameButton = document.getElementById('create-game-button');
    
    let matchmakingActive = false;
    let currentGameId = null;
    let queueStartTime = null;
    let queueTimerInterval = null;
    let pollInterval = null;
    let selectedFaction = 'TERRAN'; // Default faction
    let factionData = null; // Cached faction data from API

    // Fetch faction data from API
    async function fetchFactionData() {
        try {
            const response = await fetch('/api/rts/factions');
            if (!response.ok) {
                throw new Error('Failed to fetch faction data');
            }
            factionData = await response.json();
            console.log('Loaded faction data:', factionData);
            renderFactionCards();
        } catch (error) {
            console.error('Error fetching faction data:', error);
            // Fall back to hardcoded faction cards if API fails
        }
    }

    // Render faction cards from API data
    function renderFactionCards() {
        if (!factionData) return;
        
        const factionSelector = document.querySelector('.faction-selector');
        factionSelector.innerHTML = ''; // Clear existing cards
        
        factionData.forEach((faction, index) => {
            const card = document.createElement('div');
            card.className = 'faction-card' + (index === 0 ? ' selected' : '');
            card.dataset.faction = faction.factionId;
            card.onclick = () => selectFaction(faction.factionId);
            
            const colorHex = '#' + faction.themeColor.toString(16).padStart(6, '0');
            
            // Build bonuses/penalties HTML
            const bonusesHtml = faction.bonuses.map(b => `<div style="color: #00ff88; font-size: 0.85em; margin: 2px 0;">‚úì ${b}</div>`).join('');
            const penaltiesHtml = faction.penalties.map(p => `<div style="color: #ff6666; font-size: 0.85em; margin: 2px 0;">‚úó ${p}</div>`).join('');
            
            card.innerHTML = `
                <div class="faction-icon">${faction.icon}</div>
                <div class="faction-name" style="color: ${colorHex};">${faction.displayName}</div>
                <div class="faction-description">
                    ${faction.description}
                </div>
                ${bonusesHtml ? `<div style="margin-top: 10px;">${bonusesHtml}</div>` : ''}
                ${penaltiesHtml ? `<div style="margin-top: 5px;">${penaltiesHtml}</div>` : ''}
            `;
            
            factionSelector.appendChild(card);
        });
    }

    // Faction selection
    function selectFaction(factionName) {
        selectedFaction = factionName;
        
        // Update UI
        document.querySelectorAll('.faction-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`.faction-card[data-faction="${factionName}"]`).classList.add('selected');
        
        console.log('Selected faction:', factionName);
    }

    function fetchLobbyInfo() {
        fetch('/api/rts/lobby')
            .then(response => response.json())
            .then(lobbyInfo => {
                updateLobby(lobbyInfo);
                updateServerStatus(true);
            })
            .catch(error => {
                console.error('Error fetching lobby info:', error);
                updateServerStatus(false);
                showErrorState();
            });
    }

    function updateServerStatus(isOnline) {
        if (isOnline) {
            serverStatus.textContent = 'üü¢';
            serverStatus.parentElement.querySelector('.stat-label').textContent = 'Server Online';
        } else {
            serverStatus.textContent = 'üî¥';
            serverStatus.parentElement.querySelector('.stat-label').textContent = 'Server Offline';
        }
    }

    function showErrorState() {
        gamesList.innerHTML = `
            <li class="empty-state">
                <div>‚ö†Ô∏è Connection Error</div>
                <div>Unable to connect to game server.</div>
            </li>
        `;
    }

    function updateLobby(lobbyInfo) {
        playerCountValue.textContent = lobbyInfo.playerCount || 0;
        gamesCountValue.textContent = lobbyInfo.matchmakingGames ? lobbyInfo.matchmakingGames.length : 0;

        // Update active games list
        gamesList.innerHTML = '';
        if (lobbyInfo.matchmakingGames && lobbyInfo.matchmakingGames.length > 0) {
            lobbyInfo.matchmakingGames.forEach(game => {
                const listItem = document.createElement('li');
                listItem.className = 'game-item';

                const currentPlayers = game.currentPlayers || 0;
                const maxPlayers = game.maxPlayers || 2;
                const isWaiting = currentPlayers < maxPlayers;
                const isFull = currentPlayers >= maxPlayers;

                listItem.innerHTML = `
                    <div class="game-header">
                        <div class="game-type">Game ${game.gameId}</div>
                        <div class="game-status ${isWaiting ? 'waiting' : 'ready'}">
                            ${isWaiting ? 'Waiting for Players' : 'Starting Soon'}
                        </div>
                    </div>
                    <div class="game-info">
                        <div class="info-item">
                            <span class="info-label">Players:</span>
                            <span class="info-value">${currentPlayers}/${maxPlayers}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Game ID:</span>
                            <span class="info-value">${game.gameId}</span>
                        </div>
                    </div>
                    <button class="join-button" onclick="joinGame('${game.gameId}')" ${isFull ? 'disabled' : ''}>
                        ${isFull ? 'Full' : 'üéØ Join Game'}
                    </button>
                `;
                gamesList.appendChild(listItem);
            });
        } else {
            gamesList.innerHTML = `
                <li class="empty-state">
                    <div>No games waiting for players</div>
                    <div>Click "Find Match" to create or join a game!</div>
                </li>
            `;
        }
    }

    async function createMatch() {
        try {
            createGameButton.disabled = true;
            
            // Get selected game configuration
            const biome = document.getElementById('biome-select').value;
            const obstacleDensity = document.getElementById('density-select').value;
            const playerCount = parseInt(document.getElementById('player-count-select').value);
            
            const response = await fetch('/api/rts/matchmaking/join', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    biome: biome,
                    obstacleDensity: obstacleDensity,
                    faction: selectedFaction,
                    maxPlayers: playerCount
                })
            });

            if (!response.ok) {
                throw new Error('Failed to create match');
            }

            const result = await response.json();
            currentGameId = result.gameId;
            const sessionToken = result.sessionToken;
            
            // Store session token in sessionStorage for WebSocket connection
            if (sessionToken) {
                sessionStorage.setItem('rts_session_token', sessionToken);
                console.log('Stored session token:', sessionToken);
            }
            
            // Show matchmaking status
            createGameSection.style.display = 'none';
            matchmakingStatus.classList.add('active');
            matchmakingActive = true;
            
            // Update waiting message
            document.getElementById('waiting-message').textContent = 
                `Waiting for ${playerCount - 1} more player${playerCount > 2 ? 's' : ''} to join...`;
            
            // Start queue timer
            queueStartTime = Date.now();
            queueTimerInterval = setInterval(updateQueueTimer, 1000);
            
            // Poll for game status
            pollInterval = setInterval(checkGameStatus, 1000);
            
        } catch (error) {
            console.error('Error creating match:', error);
            alert('Failed to create match. Please try again.');
            createGameButton.disabled = false;
        }
    }

    function updateQueueTimer() {
        const elapsed = Math.floor((Date.now() - queueStartTime) / 1000);
        document.getElementById('queue-time').textContent = `Time in lobby: ${elapsed}s`;
    }

    async function checkGameStatus() {
        if (!currentGameId) return;
        
        try {
            const response = await fetch(`/api/rts/matchmaking/status/${currentGameId}`);
            if (!response.ok) return;
            
            const status = await response.json();
            
            // Update player list
            updatePlayerList(status);
            
            // If game is ready, redirect with session token
            if (status.ready) {
                clearInterval(queueTimerInterval);
                clearInterval(pollInterval);
                const sessionToken = sessionStorage.getItem('rts_session_token');
                const url = sessionToken 
                    ? `/rts.html?gameId=${currentGameId}&sessionToken=${sessionToken}`
                    : `/rts.html?gameId=${currentGameId}`;
                window.location.href = url;
            }
        } catch (error) {
            console.error('Error checking game status:', error);
        }
    }

    function updatePlayerList(status) {
        const playerList = document.getElementById('player-list');
        playerList.innerHTML = '';
        
        for (let i = 0; i < status.maxPlayers; i++) {
            const slot = document.createElement('div');
            slot.className = i < status.currentPlayers ? 'player-slot filled' : 'player-slot empty';
            
            if (i < status.currentPlayers) {
                slot.innerHTML = `
                    <div class="player-name">${i === 0 ? 'You' : 'Player ' + (i + 1)}</div>
                    <div class="player-status">Ready</div>
                `;
            } else {
                slot.innerHTML = `
                    <div class="player-name">Waiting...</div>
                    <div class="player-status">Empty</div>
                `;
            }
            
            playerList.appendChild(slot);
        }
    }

    async function cancelMatchmaking() {
        if (!currentGameId) return;
        
        try {
            const sessionToken = sessionStorage.getItem('rts_session_token');
            await fetch(`/api/rts/matchmaking/leave/${currentGameId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionToken: sessionToken })
            });
            
            // Clear session token
            sessionStorage.removeItem('rts_session_token');
        } catch (error) {
            console.error('Error leaving matchmaking:', error);
        }
        
        resetMatchmaking();
    }

    function resetMatchmaking() {
        matchmakingActive = false;
        currentGameId = null;
        createGameSection.style.display = 'block';
        matchmakingStatus.classList.remove('active');
        createGameButton.disabled = false;
        
        if (queueTimerInterval) {
            clearInterval(queueTimerInterval);
            queueTimerInterval = null;
        }
        
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
        
        fetchLobbyInfo();
    }

    async function joinGame(gameId) {
        try {
            createGameButton.disabled = true;
            
            // Join the existing game with our selected faction
            const response = await fetch('/api/rts/matchmaking/join', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    gameId: gameId,  // Specify which game to join
                    faction: selectedFaction
                })
            });

            if (!response.ok) {
                throw new Error('Failed to join game');
            }

            const result = await response.json();
            currentGameId = result.gameId;
            const sessionToken = result.sessionToken;
            
            // Store session token in sessionStorage for WebSocket connection
            if (sessionToken) {
                sessionStorage.setItem('rts_session_token', sessionToken);
                console.log('Stored session token:', sessionToken);
            }
            
            // Show matchmaking status
            createGameSection.style.display = 'none';
            matchmakingStatus.classList.add('active');
            matchmakingActive = true;
            
            // Update waiting message
            document.getElementById('waiting-message').textContent = 'Joined game! Waiting for more players...';
            
            // Start queue timer
            queueStartTime = Date.now();
            queueTimerInterval = setInterval(updateQueueTimer, 1000);
            
            // Poll for game status
            pollInterval = setInterval(checkGameStatus, 1000);
            
        } catch (error) {
            console.error('Error joining game:', error);
            alert('Failed to join game. Please try again.');
            createGameButton.disabled = false;
        }
    }

    async function createDebugGame() {
        try {
            const biome = document.getElementById('biome-select').value;
            const obstacleDensity = document.getElementById('density-select').value;
            
            console.log('DEBUG: Creating debug game with faction:', selectedFaction);
            
            const requestBody = {
                maxPlayers: 2,  // 2 players (you + 1 AI)
                teamCount: 0,   // Free-for-all (no teams)
                worldWidth: 3000,
                worldHeight: 3000,
                biome: biome,
                obstacleDensity: obstacleDensity,
                faction: selectedFaction
            };
            
            console.log('DEBUG: Request body:', JSON.stringify(requestBody));
            
            const response = await fetch('/api/rts/games', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error('Failed to create debug game');
            }

            const result = await response.json();
            console.log('DEBUG: Server response:', result);
            console.log('DEBUG: Redirecting to:', `/rts.html?gameId=${result.gameId}&sessionToken=${result.sessionToken}`);
            window.location.href = `/rts.html?gameId=${result.gameId}&sessionToken=${result.sessionToken}`;
        } catch (error) {
            console.error('Error creating debug game:', error);
            alert('Failed to create debug game. Please try again.');
        }
    }

    // Biome descriptions
    const biomeDescriptions = {
        'GRASSLAND': 'A lush grassland with scattered trees',
        'DESERT': 'A harsh desert with rocky outcrops',
        'SNOW': 'A frozen tundra with ice formations',
        'VOLCANIC': 'A volcanic wasteland with lava rocks',
        'URBAN': 'A ruined city with debris and rubble'
    };
    
    // Update biome description when selection changes
    document.getElementById('biome-select').addEventListener('change', function() {
        const selectedBiome = this.value;
        document.getElementById('biome-description').textContent = biomeDescriptions[selectedBiome];
    });
    
    // Initialize
    fetchFactionData(); // Load faction data from API
    fetchLobbyInfo();
    setInterval(fetchLobbyInfo, 3000);
</script>
</body>
</html>

